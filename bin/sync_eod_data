#!/usr/bin/env python

import os
import csv
import MySQLdb
import datetime
from sharpefolio import stocks
import json

json_data = open('variables.json')
variables = json.load(json_data)

connection = MySQLdb.connect(
    host   = variables['mysql_host'],
    user   = variables['mysql_user'],
    passwd = variables['mysql_password'],
    db     = variables['mysql_database']
)

# Set up stock mapper
stock_repository = stocks.StockMysqlRepository(connection)
stock_mapper = stocks.StockMapper(stock_repository)

# Set up price mapper
price_repository = stocks.PriceMysqlRepository(connection)
price_mapper = stocks.PriceMapper(price_repository)

path = "./EOD/"
for folder_path in os.listdir(path):
    abs_folder_path = path + folder_path
    if not os.path.isdir(abs_folder_path):
        continue

    for file_path in os.listdir(abs_folder_path):
        abs_file_path = abs_folder_path + "/" + file_path

        with open(abs_file_path, 'rb') as csvfile:
            reader = csv.reader(csvfile, delimiter=',', quotechar='|')
            rownum = 0
            info = {}
            headers = []
            for row in reader:
                if rownum == 0:
                    headers = row
                else:
                    for i, header in enumerate(headers):
                        info[headers[i]] = row[i]

                    # find stock id
                    try:
                        stock = stock_mapper.find_by_symbol(info['Symbol'])
                    except Exception:
                        # insert new stock
                        stock = stocks.Stock(symbol=info['Symbol'], company=info['Symbol'])
                        stock_mapper.insert(stock)
                        # get new stock id
                        stock = stock_mapper.find_by_symbol(info['Symbol'])

                    date = datetime.datetime.strptime(info['Date'], '%d-%b-%Y')

                    price = stocks.Price(stock_id=stock.id, date=date, closing_price=info['Close'], change=0)
                    price_mapper.insert(price)

                    print "price inserted for", info

                rownum += 1

            # break
        # break
    # break





